#!/bin/bash
set -eu

JOB_NAME=${JOB_NAME:-"standalone-6"}
JOBS_PATH=/var/vcap/jobs/${JOB_NAME} # standalone-6

source ${JOBS_PATH}/helpers/ctl_setup.sh ${JOB_NAME}

export LANG=en_US.UTF-8

case $1 in
  (start)
    pid_guard $PIDFILE $JOB_NAME

    sysctl vm.overcommit_memory=1
    echo never > /sys/kernel/mm/transparent_hugepage/enabled || true

    chpst -u vcap:vcap redis-server --version \
      > /var/vcap/store/standalone-6/REDIS_VERSION_FULL
    chpst -u vcap:vcap redis-server --version | 
      sed -e 's/.* v=\([^ ]*\).*/\1/' > /var/vcap/store/standalone-6/REDIS_VERSION
    chown vcap:vcap /var/vcap/store/standalone-6/REDIS_VERSION_FULL /var/vcap/store/standalone-6/REDIS_VERSION

    <% if p('persistent') %>
    cd /var/vcap/store/standalone-6
    <% end %>

    echo $$ > $PIDFILE

    <% if p('redis.tls.enabled') -%>
    #TLS_PATH=/var/vcap/jobs/redis-blacksmith-plans/config/tls ???
    exec chpst -u vcap:vcap redis-server \
      --port <%= p('redis.tls.dual-mode') == "true" ? 6380 : 0 -%> \
      --tls-port 6379 \
      --tls-cert-file ${JOBS_PATH}/config/tls/redis.crt \
      --tls-key-file ${JOBS_PATH}/config/tls/redis.key \
      --tls-ca-cert-file ${JOBS_PATH}/config/tls/redis.ca \
      $JOB_DIR/config/redis.conf \
      >>$LOG_DIR/$JOB_NAME.log 2>&1
    <% else %>
    exec chpst -u vcap:vcap redis-server \
      $JOB_DIR/config/redis.conf \
      >>$LOG_DIR/$JOB_NAME.log 2>&1
    <% end %>
    ;;

  (stop)
    kill_and_wait $PIDFILE
    ;;

  (*)
    echo "Usage: ctl {start|stop}"
    ;;
esac
exit 0
